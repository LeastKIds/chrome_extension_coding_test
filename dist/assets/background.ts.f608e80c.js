chrome.runtime.onMessage.addListener(function(o,c,a){if(o.type==="login"){console.log("Login message received");const t=o.data.TOKEN;let e=!1;return fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${t}`}}).then(s=>s.json()).then(s=>{const i=s.login;chrome.storage.sync.set({USER:i,TOKEN:t},function(){if(chrome.runtime.lastError){e||(a({status:!1,data:{errMessage:chrome.runtime.lastError.message}}),e=!0);return}console.log("Saved user name"),e||(a({status:!0,data:{USER:i}}),e=!0)})}).catch(s=>{e||(a({status:!1,data:{errMessage:s.toString()}}),e=!0)}),!0}else if(o.type==="repo"){let t=!1;return chrome.storage.sync.get(["USER","TOKEN"],e=>{if(e.USER){const s=e.USER,i=e.TOKEN,n=o.data.REPO;fetch(`https://api.github.com/repos/${s}/${n}`).then(r=>r.json()).then(r=>{chrome.storage.sync.set({USER:s,TOKEN:i,REPO:n},function(){if(chrome.runtime.lastError){t||(a({status:!1,data:{errMessage:chrome.runtime.lastError.message}}),t=!0);return}console.log("Saved repo"),t||(a({status:!0,data:{REPO:n}}),t=!0)})}).catch(r=>{t||(a({status:!1,data:{errMessage:r.toString()}}),t=!0)})}else t||(a({status:!1,data:{errMessage:e}}),t=!0)}),!0}else if(o.type==="auth"){let t=!1;return chrome.storage.sync.get(["USER","TOKEN","REPO"],e=>{e.USER&&e.TOKEN&&e.REPO?y(e.TOKEN,e.REPO).then(s=>{s?t||(a({status:!0,data:{USER:e.USER,REPO:e.REPO}}),t=!0):t||(a({status:!1,data:{errMessage:"Auth failed"}}),t=!0)}).catch(s=>{t||(a({status:!1,data:{errMessage:s.toString()}}),t=!0)}):t||(a({status:!1,data:{errMessage:e}}),t=!0)}),!0}else if(o.type==="github"){let t=!1;return chrome.storage.sync.get(["USER","TOKEN","REPO"],e=>{if(e.USER&&e.TOKEN&&e.REPO){const s=e.USER,i=e.TOKEN,n=e.REPO;N(s,i,n,o.data).then(r=>{switch(r.result){case!0:t||(a({status:!0,data:{message:r.message}}),t=!0);break;case!1:t||(a({status:!1,data:{errMessage:r.message}}),t=!0);break}}).catch(r=>{t||(a({status:!1,data:{errMessage:r.toString()}}),t=!0)})}else t||(a({status:!1,data:{errMessage:e}}),t=!0)}),!0}});async function y(o,c){const a=await fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${o}`}});if(!a.ok)return!1;const e=(await a.json()).login;return!!(await fetch(`https://api.github.com/repos/${e}/${c}`)).ok}async function N(o,c,a,t){const e=t.title,s=t.content,i=t.codeTxt,n=t.codeExtension,r=t.codeSpeed,S=t.codeSpeedRanking,O=t.codeMemory,T=t.codeMemoryRanking;if(!await y(c,a))return{result:!1,message:"Auth failed"};const h={Authorization:`Bearer ${c}`,Accept:"application/vnd.github.v3+json"},f=await fetch(`https://api.github.com/repos/${o}/${a}/branches/main`,{headers:h});if(!f.ok)return{result:!1,message:f};const u=(await f.json()).commit.sha,g=await fetch(`https://api.github.com/repos/${o}/${a}/git/commits/${u}`,{headers:h}),m=await g.json();if(!g.ok)return{result:!1,message:m};const d=m.tree.sha,l=await fetch(`https://api.github.com/repos/${o}/${a}/git/trees`,{method:"POST",headers:{...h,"Content-Type":"application/json"},body:JSON.stringify({base_tree:d,tree:[{path:e+"/"+e+"."+n,mode:"100644",type:"blob",content:i},{path:e+"/"+e+".md",mode:"100644",type:"blob",content:s}]})}),w=await l.json();if(!l.ok)return{result:!1,message:d};const $=w.sha,p=await fetch(`https://api.github.com/repos/${o}/${a}/git/commits`,{method:"POST",headers:{...h,"Content-Type":"application/json"},body:JSON.stringify({message:r+" "+S+" "+O+" "+T,tree:$,parents:[u]})}),E=await p.json();if(!p.ok)return{result:!1,message:E};const k=E.sha,b=await fetch(`https://api.github.com/repos/${o}/${a}/git/refs/heads/main`,{method:"PATCH",headers:{...h,"Content-Type":"application/json"},body:JSON.stringify({sha:k})}),M=await b.json();return b.ok?{result:!0,message:"Success"}:{result:!1,message:M}}
