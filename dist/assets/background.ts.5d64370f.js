chrome.runtime.onMessage.addListener(function(o,c,a){if(o.type==="login"){console.log("Login message received");const t=o.data.TOKEN;let e=!1;return fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${t}`}}).then(s=>s.json()).then(s=>{const n=s.login;chrome.storage.sync.set({USER:n,TOKEN:t},function(){if(chrome.runtime.lastError){e||(a({status:!1,data:{errMessage:chrome.runtime.lastError.message}}),e=!0);return}console.log("Saved user name"),e||(a({status:!0,data:{USER:n}}),e=!0)})}).catch(s=>{e||(a({status:!1,data:{errMessage:s.toString()}}),e=!0)}),!0}else if(o.type==="repo"){let t=!1;return chrome.storage.sync.get(["USER","TOKEN"],e=>{if(e.USER){const s=e.USER,n=e.TOKEN,i=o.data.REPO;fetch(`https://api.github.com/repos/${s}/${i}`).then(r=>r.json()).then(r=>{chrome.storage.sync.set({USER:s,TOKEN:n,REPO:i},function(){if(chrome.runtime.lastError){t||(a({status:!1,data:{errMessage:chrome.runtime.lastError.message}}),t=!0);return}console.log("Saved repo"),t||(a({status:!0,data:{REPO:i}}),t=!0)})}).catch(r=>{t||(a({status:!1,data:{errMessage:r.toString()}}),t=!0)})}else t||(a({status:!1,data:{errMessage:e}}),t=!0)}),!0}else if(o.type==="auth"){let t=!1;return chrome.storage.sync.get(["USER","TOKEN","REPO"],e=>{e.USER&&e.TOKEN&&e.REPO?l(e.TOKEN,e.REPO).then(s=>{s?t||(a({status:!0,data:{USER:e.USER,REPO:e.REPO}}),t=!0):t||(a({status:!1,data:{errMessage:"Auth failed"}}),t=!0)}).catch(s=>{t||(a({status:!1,data:{errMessage:s.toString()}}),t=!0)}):t||(a({status:!1,data:{errMessage:e}}),t=!0)}),!0}else if(o.type==="github"){let t=!1;return chrome.storage.sync.get(["USER","TOKEN","REPO"],e=>{if(e.USER&&e.TOKEN&&e.REPO){const s=e.USER,n=e.TOKEN,i=e.REPO;T(s,n,i,o.data).then(r=>{switch(r.result){case!0:t||(a({status:!0,data:{message:r.message}}),t=!0);break;case!1:t||(a({status:!1,data:{errMessage:r.message}}),t=!0);break}}).catch(r=>{t||(a({status:!1,data:{errMessage:r.toString()}}),t=!0)})}else t||(a({status:!1,data:{errMessage:e}}),t=!0)}),!0}});async function l(o,c){const a=await fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${o}`}});if(!a.ok)return!1;const e=(await a.json()).login;return!!(await fetch(`https://api.github.com/repos/${e}/${c}`)).ok}async function T(o,c,a,t){const e=t.title,s=t.markdown,n=t.codeTxt,i=t.codeExtension,r=t.codeSpeed,p=t.codeSpeedRanking,E=t.codeMemory,b=t.codeMemoryRanking;if(!await l(c,a))return{result:!1,message:"Auth failed"};const h={Authorization:`Bearer ${c}`,Accept:"application/vnd.github.v3+json"},f=await fetch(`https://api.github.com/repos/${o}/${a}/branches/main`,{headers:h});if(!f.ok)return{result:!1,message:"Branch sha not found"};const u=(await f.json()).commit.sha,m=await fetch(`https://api.github.com/repos/${o}/${a}/git/commits/${u}`,{headers:h});if(!m.ok)return{result:!1,message:"Commit sha not found"};const y=(await m.json()).tree.sha,g=await fetch(`https://api.github.com/repos/${o}/${a}/git/trees`,{method:"POST",headers:{...h,"Content-Type":"application/json"},body:JSON.stringify({base_tree:y,tree:[{path:e+"/"+e+"."+i,mode:"100644",type:"blob",content:n},{path:e+"/"+e+".md",mode:"100644",type:"blob",content:s}]})});if(!g.ok)return{result:!1,message:"Tree not found"};const S=(await g.json()).sha,d=await fetch(`https://api.github.com/repos/${o}/${a}/git/commits`,{method:"POST",headers:{...h,"Content-Type":"application/json"},body:JSON.stringify({message:r+" "+p+" "+E+" "+b,tree:S,parents:[u]})});if(!d.ok)return{result:!1,message:"New commit not found"};const O=(await d.json()).sha;return(await fetch(`https://api.github.com/repos/${o}/${a}/git/refs/heads/main`,{method:"PATCH",headers:{...h,"Content-Type":"application/json"},body:JSON.stringify({sha:O})})).ok?{result:!0,message:"Success"}:{result:!1,message:"Update not found"}}
